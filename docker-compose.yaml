version: "3.9"

services:
  # <<-- NGINX -->>
  nginx:
    depends_on:
      - app
      - recommendation-ms
      - user-ms
      - watchlist-ms
      - analytics-ms
    restart: always
    build:
      context: ./nginx
      dockerfile: Dockerfile
    ports:
      - 3000:3000

  # <<-- FRONTEND -->>
  app:
    build:
      context: ./app
      dockerfile: Dockerfile
    env_file:
      ./app/.env
    environment:
      - REACT_APP_RECOMMENDATION_MS=/recommendation-ms
      - REACT_APP_USER_MS=/user-ms
      - REACT_APP_WATCHLIST_MS=/watchlist-ms
      - REACT_APP_ANALYTICS_MS=/analytics-ms

  # <<-- BACKEND -->>
  user-ms:
    build: ./backend/user-ms/
    ports:
     - '3360:3360'
    expose:
     - '3360'
    depends_on:
      user-db:
        condition: service_healthy
    links:
     - user-db

  user-db:
    image: mysql:latest
    ports:
      - '3306:3306'
    expose:
      - '3306'
    environment:
      MYSQL_ROOT_PASSWORD: 1111
      MYSQL_HOST: "used-db"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-P", "3306"]
      interval: 10s
      timeout: 30s
      retries: 5


  watchlist-ms:
    build:
      context: ./backend/watchlist-ms/
      dockerfile: ../../fastapi.dockerfile
  watchlist-db:
    image: cassandra:latest
    ports:
      - '9093:9093'
    healthcheck:
      test: ["CMD-SHELL", "[ $$(nodetool statusgossip) = running ]"]
      interval: 30s
      timeout: 10s
      retries: 5

  watchlist-db-setuper:
    image: cassandra:latest
    depends_on:
      watchlist-db:
        condition:
          service_healthy
    restart: "no"

    entrypoint: ["/setup_watchlist-db.sh"]
    volumes:
      - ./scripts/create_tables.cql:/create_tables.cql
      - ./scripts/setup_watchlist-db.sh:/setup_watchlist-db.sh

  analytics-ms:
    build:
      context: ./backend/analytics-ms/
      dockerfile: ../../fastapi.dockerfile

  analytics-db:
    image: mongo:latest
    restart: always
    ports:
      - "27017:27017"

  recommendation-ms:
    build: ./backend/recommendation-ms
    ports:
      - "80:80"
    depends_on:
      - neo4j
    environment:
      - NEO4J_HOST=neo4j
      - NEO4J_PORT=7687
      - NEO4J_USERNAME=myusername
      - NEO4J_PASSWORD=mypassword
      - TMDB_API_KEY=9be9f81b03a97c8ad1b8a4a41fb190bd
      - TMDB_API_ENDPOINT=https://api.themoviedb.org/3

  neo4j:
    image: neo4j:latest
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/mypassword
